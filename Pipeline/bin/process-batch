#!/usr/bin/perl
#
# Feed all related warcs files per source through a set of tasks.
#

use warnings;
use strict;

use OSF::CommonCrawl::WarcSet  ();
use File::Basename  qw(basename);

my @task_pkgs = grep /^[\w:]+$/, split ' ', $ENV{PIPELINE_TASKS};
@task_pkgs or die "ERROR: No PIPELINE_TASKS in the environment\n";

@ARGV==1
   or die "Usage: $0 <dir>\n";

my $workdir = $ARGV[0];
-d $workdir or die "ERROR: workdir '$workdir' does not exist\n";

my $cc = OSF::CommonCrawl::WarcSet->new(
  dir  => $workdir,
  name => basename($workdir),
);

my @tasks;
foreach my $task_pkg (@task_pkgs)
{   eval "require $task_pkg";
    die $@ if $@;

    push @tasks, $task_pkg->new;
}

while(my $product = $cc->getProduct)
{   #print $product->part('request')->uri, "\n";

    $_->filter($product) for @tasks;

#sleep 1;
}

$_->finish(batch => $cc) for @tasks;
